<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hale Pueo - homestead tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f1de;
        }
        .container {
            max-width: 1100px;
            margin: 1rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4a5568;
        }
        .tab-button:hover {
            background-color: #f7fafc;
            border-bottom-color: #a57c5b;
        }
        .tab-button.active {
            border-bottom-color: #8db580;
            color: #2d3748;
            font-weight: 600;
        }
        .tab-content {
            display: none;
            padding-top: 1.5rem;
        }
        .tab-content.active {
            display: block;
        }

        .form-input, .form-textarea, .form-date, .form-datetime, .form-select, .form-file {
            border-color: #c7c7c7;
            transition: border-color 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-date:focus, .form-datetime:focus, .form-select:focus, .form-file:focus {
            border-color: #8db580;
            box-shadow: 0 0 0 2px rgba(141, 181, 128, 0.3);
            outline: none;
        }
        .action-button {
            background-color: #a57c5b;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease;
        }
        .action-button:hover {
            background-color: #8c694c;
        }
        .action-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        
        #messageBox, #loadingBox, #errorBox, #activityMessageBox, #taskMessageBox {
            transition: opacity 0.5s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8db580;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #farmMapViewport {
            width: 100%;
            height: 75vh;
            max-height: 800px;
            border: 2px solid #acc6a0;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
            background-color: #e6f0e1;
        }
       
        .asset-image, .activity-image, .popup-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        .asset-image, .activity-image {
             max-height: 200px;
        }
        .popup-image {
            max-height: 150px;
        }

        #modalNewActivityImagePreview:empty, #modalNewActivityImagePreview[src="#"] {
            display: none;
        }
        .notes-textarea {
            min-height: 80px;
        }
        .activity-log-entry, .task-list-item, .recent-activity-item {
            border-bottom: 1px solid #eee;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .activity-log-entry:last-child, .task-list-item:last-child, .recent-activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .priority-High { color: #e53e3e; font-weight: bold; }
        .priority-Medium { color: #dd6b20; }
        .priority-Low { color: #38a169; }
        .task-completed { text-decoration: line-through; color: #a0aec0; }
        .task-completed .font-semibold { font-weight: normal; }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            color: #777;
            cursor: pointer;
            background: none;
            border: none;
        }
        .modal-close-button:hover {
            color: #333;
        }
        
        #imageZoomModal .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            padding: 0.5rem;
            background-color: #333;
        }
        #zoomedImage {
            display: block;
            max-width: 100%;
            max-height: calc(90vh - 40px);
            margin: auto;
            border-radius: 4px;
        }
        #taskLocationPickerMap {
            height: 300px;
            width: 100%;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 5px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content {
            margin: 13px 19px !important;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .leaflet-popup-content p {
            margin: 0.5em 0 !important;
        }
         .leaflet-popup-content strong {
            color: #333;
        }
        .leaflet-popup-content .popup-image {
            margin-bottom: 0.5em;
        }
        .leaflet-popup-content .popup-notes {
            max-height: 60px;
            overflow-y: auto;
            font-size: 0.8rem;
            color: #555;
            border-top: 1px solid #eee;
            margin-top: 0.5em;
            padding-top: 0.5em;
        }
        /* Custom Leaflet DivIcon Styles */
        .leaflet-div-icon {
            background-clip: padding-box;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-align: center;
            line-height: 26px;
            font-size: 13px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.7);
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            border-width: 2px;
            border-style: solid;
        }
        .tree-marker { background-color: rgba(76, 175, 80, 0.9); border-color: rgba(46, 125, 50, 1); }
        .plant-marker { background-color: rgba(139, 195, 74, 0.9); border-color: rgba(104, 159, 56, 1); }
        .poultry-marker { background-color: rgba(255, 193, 7, 0.9); border-color: rgba(251, 140, 0, 1); }
        .structure-marker { background-color: rgba(158, 158, 158, 0.9); border-color: rgba(97, 97, 97, 1); }
        .other-marker { background-color: rgba(33, 150, 243, 0.9); border-color: rgba(25, 118, 210, 1); }
    </style>
</head>
<body class="text-gray-800">

    <div class="container">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-[#5c4033]">Hale Pueo - homestead tracker</h1>
        </header>

        <div class="mb-6 border-b border-gray-300">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button onclick="openTab(event, 'dashboardTab')" class="tab-button active" id="dashboardTabButton">Dashboard</button>
                <button onclick="openTab(event, 'recentActivityTab')" class="tab-button" id="recentActivityTabButton">Recent Activity</button>
                <button onclick="openTab(event, 'tasksTab')" class="tab-button" id="tasksTabButton">Task Priority</button>
                <button onclick="openTab(event, 'aboutTab')" class="tab-button" id="aboutTabButton">About Hale Pueo</button>
            </nav>
        </div>

        <div id="loadingBox" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg relative mb-4 text-center" role="status"></div>
        <div id="messageBox" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-4 text-center" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline" id="successMessageText"></span>
        </div>
        <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 text-center" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorMessageText"></span>
        </div>
        <div id="activityMessageBox" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg relative mb-4 text-center">
             <span class="block sm:inline" id="activityMessageText"></span>
        </div>
         <div id="taskMessageBox" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg relative mb-4 text-center">
             <span class="block sm:inline" id="taskMessageText"></span>
        </div>

        <div id="dashboardTab" class="tab-content active">
            <div id="farmMapViewport">
            </div>
            <p class="text-center text-sm text-gray-500 italic">Click on a map marker to view details and log activity.</p>
        </div>

        <div id="recentActivityTab" class="tab-content">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">Recent Homestead Activities</h2>
            <div id="recentActivityContainer" class="max-h-[75vh] overflow-y-auto space-y-4">
                <p class="text-gray-500">Loading recent activities...</p>
            </div>
        </div>


        <div id="aboutTab" class="tab-content">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">About Hale Pueo Homestead</h2>
            <div class="prose max-w-none text-gray-700">
                 <h3 class="text-xl font-semibold mt-6 mb-1">Basic Farm Layout <span class="text-sm text-gray-500">(click image to enlarge)</span></h3>
                <figure class="my-2">
                    <img src="https://i.imgur.com/YsWPqY9.jpeg"
                         alt="Hale Pueo Farm Layout"
                         class="rounded-lg shadow-md cursor-pointer w-full md:w-2/3 lg:w-1/2 mx-auto"
                         onclick="openImageZoomModal('https://i.imgur.com/YsWPqY9.jpeg')">
                </figure>
                <p class="mt-4">Welcome to Hale Pueo, our little slice of paradise in Hāna, Maui!</p>
                <p>This homestead tracker is a digital companion to our efforts in cultivating a sustainable and productive 3-acre farm. We are home to a variety of fruit trees, a lively flock of chickens, and happy ducks enjoying the tropical environment.</p>
                <h3 class="text-xl font-semibold mt-6 mb-2">Our Vision</h3>
                <p>Our goal is to blend traditional farming wisdom with modern tools to create a thriving ecosystem. We believe in:
                    <ul>
                        <li>Sustainable practices that nurture the land.</li>
                        <li>Growing a diverse range of foods for our family and community.</li>
                        <li>Providing a healthy and happy environment for our animals.</li>
                        <li>Continuously learning and adapting to the unique challenges and joys of farming in Hāna.</li>
                    </ul>
                </p>
                <h3 class="text-xl font-semibold mt-6 mb-2">This Tracker</h3>
                <p>This digital tool helps us:
                    <ul>
                        <li>Keep an inventory of our assets, from individual trees to our poultry.</li>
                        <li>Track activities, maintenance schedules, and observations.</li>
                        <li>Monitor the health and productivity of our plants and animals.</li>
                        <li>Make informed decisions to improve our homesteading practices.</li>
                        <li>Manage and prioritize tasks around the homestead.</li>
                    </ul>
                </p>
                <p>Feel free to explore the dashboard to see what's happening on the farm!</p>
            </div>
        </div>

        <div id="tasksTab" class="tab-content">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">Task Priority</h2>
            <div class="mb-4">
                <label for="showCompletedTasksToggle" class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="showCompletedTasksToggle" class="form-input rounded h-5 w-5 text-green-600 focus:ring-green-500" onchange="populateTasksDisplay()">
                    <span class="ml-2 text-gray-700">Show Completed Tasks</span>
                </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <h3 class="text-xl font-semibold mb-3">Task List</h3>
                    <div id="taskListContainer" class="space-y-3 max-h-96 overflow-y-auto bg-white p-4 rounded-md border">
                        <p class="text-gray-500">Loading tasks or no tasks found.</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Add New Task</h3>
                    <div id="addTaskForm" class="space-y-3 bg-white p-4 border rounded-md">
                        <div>
                            <label for="newTaskName" class="block text-sm font-medium text-gray-700">Task Name:</label>
                            <input type="text" id="newTaskName" class="form-input mt-1 block w-full rounded-md p-2" placeholder="e.g., Prune Mango Trees">
                        </div>
                        <div>
                            <label for="newTaskDescription" class="block text-sm font-medium text-gray-700">Description:</label>
                            <textarea id="newTaskDescription" rows="3" class="form-textarea notes-textarea mt-1 block w-full rounded-md p-2" placeholder="Details about the task..."></textarea>
                        </div>
                        <div>
                            <label for="newTaskDueDate" class="block text-sm font-medium text-gray-700">Due Date (Optional):</label>
                            <input type="date" id="newTaskDueDate" class="form-date mt-1 block w-full rounded-md p-2">
                        </div>
                        <div>
                            <label for="newTaskAssetId" class="block text-sm font-medium text-gray-700">Related Asset (Optional):</label>
                            <select id="newTaskAssetId" class="form-select mt-1 block w-full rounded-md p-2">
                                <option value="">None</option>
                            </select>
                        </div>
                         <div>
                            <label for="newTaskMapZone" class="block text-sm font-medium text-gray-700">Map Zone (Optional):</label>
                            <input type="text" id="newTaskMapZone" class="form-input mt-1 block w-full rounded-md p-2" placeholder="e.g., Orchard, Coop Area">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Task Location (Optional):</label>
                            <input type="hidden" id="newTaskLat">
                            <input type="hidden" id="newTaskLon">
                            <button type="button" onclick="openTaskLocationPickerModal()" class="text-sm text-blue-600 hover:underline mt-1">Set Task Location on Map</button>
                            <span id="taskLocationCoordsDisplay" class="text-xs text-gray-500 ml-2 block mt-1">No location set</span>
                        </div>
                        <div>
                            <label for="newTaskPriority" class="block text-sm font-medium text-gray-700">Priority:</label>
                            <select id="newTaskPriority" class="form-select mt-1 block w-full rounded-md p-2">
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <button id="saveTaskButton" onclick="saveNewTask()" class="action-button w-full">Add Task to Sheet</button>
                    </div>
                </div>
            </div>
        </div>
        
        <p class="text-xs text-gray-500 mt-6 text-center">Note: Asset list is loaded from a Google Sheet. New activities and tasks are sent to a Google Apps Script to be saved.</p>
    </div>

    <div id="assetInfoModal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeAssetModal()" class="modal-close-button">&times;</button>
            <h3 id="modalAssetName" class="text-2xl font-semibold text-gray-700 mb-4">Asset Details</h3>
            
            <div id="modalStaticAssetInfo" class="mb-4 p-4 border border-gray-200 rounded-md bg-white">
                <h4 class="font-semibold text-lg mb-2">Asset Information</h4>
                <p><strong>ID:</strong> <span id="modalStaticAssetId"></span></p>
                <p><strong>Name:</strong> <span id="modalStaticAssetName"></span></p>
                <p><strong>Type:</strong> <span id="modalStaticAssetType"></span></p>
                <p><strong>Description:</strong> <span id="modalStaticAssetDescription" class="text-sm text-gray-600 whitespace-pre-wrap"></span></p>
                <hr class="my-3">
                <p><strong>Last Activity Date:</strong> <span id="modalStaticAssetLastActivityDate"></span></p>
                <div id="modalStaticAssetImageContainer" class="mt-2"></div>
                <p class="mt-2"><strong>Latest Activity Notes:</strong> <span id="modalStaticAssetLatestNotes" class="text-sm text-gray-600 whitespace-pre-wrap"></span></p>
            </div>

            <hr class="my-6">

            <div id="modalActivityTrackerSection">
                <h4 class="font-semibold text-lg mb-3">Full Activity Log (Persists Across Sessions)</h4>
                <div id="modalLatestActivityDisplay" class="mb-4 p-3 border border-dashed border-gray-300 rounded-md bg-gray-100 max-h-48 overflow-y-auto">
                    <p class="text-center text-gray-500">Loading activities or no activities found for this asset.</p>
                </div>
                <h4 class="font-semibold text-lg mb-3 mt-6">Add New Activity</h4>
                <div id="modalAddActivityForm" class="space-y-3 bg-white p-4 border rounded-md">
                    <div>
                        <label for="modalNewActivityDateTime" class="block text-sm font-medium text-gray-700">Date & Time of Activity:</label>
                        <input type="datetime-local" id="modalNewActivityDateTime" class="form-datetime mt-1 block w-full rounded-md p-2">
                    </div>
                    <div>
                        <label for="modalNewActivityNote" class="block text-sm font-medium text-gray-700">New Note:</label>
                        <textarea id="modalNewActivityNote" rows="3" class="form-textarea notes-textarea mt-1 block w-full rounded-md p-2" placeholder="Enter activity details..."></textarea>
                    </div>
                    <div>
                        <label for="modalNewActivityImageFile" class="block text-sm font-medium text-gray-700">Upload Photo (Optional):</label>
                        <input type="file" id="modalNewActivityImageFile" class="form-file mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-green-50 file:text-green-700
                                hover:file:bg-green-100" accept="image/*">
                        <img id="modalNewActivityImagePreview" src="#" alt="Image Preview" class="mt-2 hidden" style="max-height: 150px;"/>
                    </div>
                    <button id="saveModalActivityButton" onclick="saveModalActivity()" class="action-button w-full">Save Activity to Sheet</button>
                </div>
            </div>
        </div>
    </div>

    <div id="imageZoomModal" class="modal-overlay" onclick="closeImageZoomModal()">
        <div class="modal-content p-2 relative" onclick="event.stopPropagation()">
            <button onclick="closeImageZoomModal()" class="modal-close-button text-white hover:text-gray-300" style="top:0; right: 5px; font-size:2.5rem;">&times;</button>
            <img id="zoomedImage" src="" alt="Zoomed Image" class="max-w-full max-h-full">
        </div>
    </div>
    
    <div id="taskLocationModal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeTaskLocationPickerModal()" class="modal-close-button">&times;</button>
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Pick Task Location</h3>
            <div id="taskLocationPickerMap"></div>
            <p class="text-xs text-gray-500 mt-2">Click on the map to select a location for the task.</p>
            <button onclick="confirmTaskLocation()" class="action-button mt-3 bg-green-600 hover:bg-green-700">Confirm Location</button>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script>
        // --- Configuration ---
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXl17fkaqYmdxU7pJ00Z4WWkglWndAJFhyKDz-axqR2u4zeUQOfgFR94eqp5ZipCwGZ3Ycm1eBu7Tl/pub?gid=0&single=true&output=csv';
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3zMYClFhZCyGoY0qHgxM89C4nskyvyqg-9R6nz5iw93mZ5XcgAt7nKlaPNzZCYr6C/exec';

        // --- Global Variables ---
        let farmData = {};
        let assetActivities = {};
        let taskListData = [];
        let selectedAssetIdForModal = null;
        let newActivitySelectedFile = null;
        let dashboardMap = null;
        let taskLocationPickerMap = null;
        let temporaryTaskMarker = null;

        // --- DOM Elements (will be cached) ---
        let messageBox, successMessageText, loadingBox, errorBox, errorMessageText,
            activityMessageBox, activityMessageText, taskMessageBox, taskMessageText,
            farmMapViewport,
            modalAssetName, modalStaticAssetId,
            modalStaticAssetName, modalStaticAssetType, modalStaticAssetDescription,
            modalStaticAssetLastActivityDate, modalStaticAssetImageContainer,
            modalStaticAssetLatestNotes, modalLatestActivityDisplay,
            modalNewActivityDateTimeInput, modalNewActivityNoteInput,
            modalNewActivityImageFileInput, modalNewActivityImagePreview, saveModalActivityButton,
            recentActivityContainer,
            taskListContainer, newTaskNameInput, newTaskDescriptionInput, newTaskDueDateInput,
            newTaskAssetIdSelect, newTaskMapZoneInput, newTaskPriorityInput,
            showCompletedTasksToggle, saveTaskButton, imageZoomModal, zoomedImage,
            assetInfoModal, taskLocationModal, taskLocationPickerMapElement,
            newTaskLatInput, newTaskLonInput, taskLocationCoordsDisplay;

        // --- FUNCTION DEFINITIONS ---
        function cacheDOMElements() {
            console.log("Attempting to cache DOM elements...");
            messageBox = document.getElementById('messageBox');
                if (!messageBox) console.error("CRITICAL CACHE ERROR: messageBox not found");
            successMessageText = document.getElementById('successMessageText');
                if (!successMessageText) console.error("CRITICAL CACHE ERROR: successMessageText not found");
            loadingBox = document.getElementById('loadingBox');
                if (!loadingBox) console.error("CRITICAL CACHE ERROR: loadingBox not found");
            errorBox = document.getElementById('errorBox');
                if (!errorBox) console.error("CRITICAL CACHE ERROR: errorBox not found");
            errorMessageText = document.getElementById('errorMessageText');
                if (!errorMessageText) console.error("CRITICAL CACHE ERROR: errorMessageText not found");
            activityMessageBox = document.getElementById('activityMessageBox');
                if (!activityMessageBox) console.error("CRITICAL CACHE ERROR: activityMessageBox not found");
            activityMessageText = document.getElementById('activityMessageText');
                 if (!activityMessageText) console.error("CRITICAL CACHE ERROR: activityMessageText not found");
            taskMessageBox = document.getElementById('taskMessageBox');
            taskMessageText = taskMessageBox ? taskMessageBox.querySelector('span') : null;
                 if (!taskMessageText && taskMessageBox) console.warn("CACHE WARNING: taskMessageText (span inside taskMessageBox) not found");

            farmMapViewport = document.getElementById('farmMapViewport');
                if (!farmMapViewport) console.error("CRITICAL CACHE ERROR: farmMapViewport not found");
            
            modalAssetName = document.getElementById('modalAssetName');
                if (!modalAssetName) console.error("CRITICAL CACHE ERROR: modalAssetName not found");
            modalStaticAssetId = document.getElementById('modalStaticAssetId');
                if (!modalStaticAssetId) console.error("CRITICAL CACHE ERROR: modalStaticAssetId not found");
            modalStaticAssetName = document.getElementById('modalStaticAssetName');
                if (!modalStaticAssetName) console.error("CRITICAL CACHE ERROR: modalStaticAssetName not found");
            modalStaticAssetType = document.getElementById('modalStaticAssetType');
                if (!modalStaticAssetType) console.error("CRITICAL CACHE ERROR: modalStaticAssetType not found");
            modalStaticAssetDescription = document.getElementById('modalStaticAssetDescription');
                if (!modalStaticAssetDescription) console.error("CRITICAL CACHE ERROR: modalStaticAssetDescription not found");
            modalStaticAssetLastActivityDate = document.getElementById('modalStaticAssetLastActivityDate');
                if (!modalStaticAssetLastActivityDate) console.error("CRITICAL CACHE ERROR: modalStaticAssetLastActivityDate not found");
            modalStaticAssetImageContainer = document.getElementById('modalStaticAssetImageContainer');
                if (!modalStaticAssetImageContainer) console.error("CRITICAL CACHE ERROR: modalStaticAssetImageContainer not found");
            modalStaticAssetLatestNotes = document.getElementById('modalStaticAssetLatestNotes');
                if (!modalStaticAssetLatestNotes) console.error("CRITICAL CACHE ERROR: modalStaticAssetLatestNotes not found");
            modalLatestActivityDisplay = document.getElementById('modalLatestActivityDisplay');
                if (!modalLatestActivityDisplay) console.error("CRITICAL CACHE ERROR: modalLatestActivityDisplay not found");
            modalNewActivityDateTimeInput = document.getElementById('modalNewActivityDateTime');
                if (!modalNewActivityDateTimeInput) console.error("CRITICAL CACHE ERROR: modalNewActivityDateTimeInput not found");
            modalNewActivityNoteInput = document.getElementById('modalNewActivityNote');
                if (!modalNewActivityNoteInput) console.error("CRITICAL CACHE ERROR: modalNewActivityNoteInput not found");
            modalNewActivityImageFileInput = document.getElementById('modalNewActivityImageFile');
                if (!modalNewActivityImageFileInput) console.error("CRITICAL CACHE ERROR: modalNewActivityImageFileInput not found");
            modalNewActivityImagePreview = document.getElementById('modalNewActivityImagePreview');
                if (!modalNewActivityImagePreview) console.error("CRITICAL CACHE ERROR: modalNewActivityImagePreview not found");
            saveModalActivityButton = document.getElementById('saveModalActivityButton');
                if (!saveModalActivityButton) console.error("CRITICAL CACHE ERROR: saveModalActivityButton not found");

            recentActivityContainer = document.getElementById('recentActivityContainer');
                if (!recentActivityContainer) console.error("CRITICAL CACHE ERROR: recentActivityContainer not found");

            taskListContainer = document.getElementById('taskListContainer');
                if (!taskListContainer) console.error("CRITICAL CACHE ERROR: taskListContainer not found");
            newTaskNameInput = document.getElementById('newTaskName');
                if (!newTaskNameInput) console.error("CRITICAL CACHE ERROR: newTaskNameInput not found");
            newTaskDescriptionInput = document.getElementById('newTaskDescription');
                if (!newTaskDescriptionInput) console.error("CRITICAL CACHE ERROR: newTaskDescriptionInput not found");
            newTaskDueDateInput = document.getElementById('newTaskDueDate');
                if (!newTaskDueDateInput) console.error("CRITICAL CACHE ERROR: newTaskDueDateInput not found");
            newTaskAssetIdSelect = document.getElementById('newTaskAssetId');
                if (!newTaskAssetIdSelect) console.error("CRITICAL CACHE ERROR: newTaskAssetIdSelect not found");
            newTaskMapZoneInput = document.getElementById('newTaskMapZone');
                if (!newTaskMapZoneInput) console.error("CRITICAL CACHE ERROR: newTaskMapZoneInput not found");
            newTaskPriorityInput = document.getElementById('newTaskPriority');
                if (!newTaskPriorityInput) console.error("CRITICAL CACHE ERROR: newTaskPriorityInput not found");
            showCompletedTasksToggle = document.getElementById('showCompletedTasksToggle');
                if (!showCompletedTasksToggle) console.error("CRITICAL CACHE ERROR: showCompletedTasksToggle not found");
            saveTaskButton = document.getElementById('saveTaskButton');
                if (!saveTaskButton) console.error("CRITICAL CACHE ERROR: saveTaskButton not found");

            imageZoomModal = document.getElementById('imageZoomModal');
                if (!imageZoomModal) console.error("CRITICAL CACHE ERROR: imageZoomModal not found");
            zoomedImage = document.getElementById('zoomedImage');
                if (!zoomedImage) console.error("CRITICAL CACHE ERROR: zoomedImage not found");
            assetInfoModal = document.getElementById('assetInfoModal');
                if (!assetInfoModal) console.error("CRITICAL CACHE ERROR: assetInfoModal not found");
            taskLocationModal = document.getElementById('taskLocationModal');
                if (!taskLocationModal) console.error("CRITICAL CACHE ERROR: taskLocationModal not found");
            taskLocationPickerMapElement = document.getElementById('taskLocationPickerMap');
                if (!taskLocationPickerMapElement) console.error("CRITICAL CACHE ERROR: taskLocationPickerMapElement not found");
            newTaskLatInput = document.getElementById('newTaskLat');
                if (!newTaskLatInput) console.error("CRITICAL CACHE ERROR: newTaskLatInput not found");
            newTaskLonInput = document.getElementById('newTaskLon');
                if (!newTaskLonInput) console.error("CRITICAL CACHE ERROR: newTaskLonInput not found");
            taskLocationCoordsDisplay = document.getElementById('taskLocationCoordsDisplay');
                if (!taskLocationCoordsDisplay) console.error("CRITICAL CACHE ERROR: taskLocationCoordsDisplay not found");
            console.log("DOM element caching complete.");
        }

        function formatDateTimeForInput(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                const timezoneOffset = date.getTimezoneOffset() * 60000;
                const localISOTime = new Date(date.getTime() - timezoneOffset).toISOString().slice(0, 16);
                return localISOTime;
            } catch (e) {
                console.warn("Error formatting date for input:", isoString, e);
                return '';
            }
        }
        
        function formatDisplayDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleString();
            } catch (e) {
                return dateString;
            }
        }

        function showLoading(isLoading, message = "Loading Data...") {
            if (!loadingBox) { console.error("loadingBox not found for showLoading"); return; }
            const loaderDiv = loadingBox.querySelector('.flex');
            if (loaderDiv) {
                 loaderDiv.innerHTML = `<div class="loader"></div><strong class="font-bold">${message.split('...')[0]}...</strong><span class="block sm:inline">${message.split('...')[1] || ''}</span>`;
            } else {
                loadingBox.innerHTML = `<div class="flex items-center justify-center"><div class="loader"></div><strong class="font-bold">${message.split('...')[0]}...</strong><span class="block sm:inline">${message.split('...')[1] || ''}</span></div>`;
            }
            loadingBox.classList.toggle('hidden', !isLoading);
        }

        function showUserMessage(element, textElement, message, isSuccess = true, duration = 5000) {
            if (!element || !textElement) {
                console.error("showUserMessage: Target element or textElement is null", element, textElement);
                return;
            }
            element.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
            if (isSuccess === true) {
                 element.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                 if (element.querySelector('strong')) element.querySelector('strong').textContent = 'Success!';
            } else if (isSuccess === false) {
                element.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                if (element.querySelector('strong')) element.querySelector('strong').textContent = 'Error!';
            } else {
                 element.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            textElement.textContent = message;
            setTimeout(() => { element.classList.add('hidden'); }, duration);
        }
        
        function getErrorMessage(error) {
            let errorDetail = "An unknown error occurred. Check console.";
            if (error) {
                if (error.message && error.message.trim() !== '' && error.message !== "[object Object]") {
                    errorDetail = error.message;
                } else if (typeof error.toString === 'function') {
                    const errStr = error.toString();
                    if (errStr.trim() !== '' && errStr !== "[object Object]") {
                        errorDetail = errStr;
                    } else {
                        errorDetail = "Error object found, see console for more details.";
                    }
                } else if (typeof error === 'string' && error.trim() !== '') {
                    errorDetail = error;
                }
            }
            return errorDetail;
        }

        function openTab(event, tabName) {
            let i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            const currentTab = document.getElementById(tabName);
            if (currentTab) {
                currentTab.style.display = "block";
                currentTab.classList.add("active");
            }
            if (event && event.currentTarget) {
                event.currentTarget.classList.add("active");
            }

            if (tabName === 'dashboardTab' && dashboardMap) {
                 setTimeout(() => dashboardMap.invalidateSize(), 0);
            }
            if (tabName === 'tasksTab' && taskLocationPickerMap && taskLocationModal.classList.contains('active')) {
                setTimeout(() => taskLocationPickerMap.invalidateSize(), 0);
            }
        }

        function csvToJSON(csvText) {
            const trimmedCsvText = csvText.trim();
            if (!trimmedCsvText) { return {}; }
            const lines = trimmedCsvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) { return {}; }
            const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
            const jsonData = {};
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentVal = '';
                let inQuotes = false;
                for (const char of lines[i]) {
                    if (char === '"' && (lines[i][lines[i].indexOf(char) -1] !== '\\') ) {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentVal.trim().replace(/^"|"$/g, ''));
                        currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
                values.push(currentVal.trim().replace(/^"|"$/g, ''));
                while (values.length < headers.length) { values.push('');}
                const entry = {};
                let assetId = '';
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    const value = values[j] || '';
                    if (header === 'assetId') assetId = value;
                    entry[header] = value;
                }
                if (assetId) { jsonData[assetId] = entry; }
            }
            return jsonData;
        }
        
        async function loadInitialData() {
            showLoading(true, "Loading initial asset data...");
            try {
                if (GOOGLE_SHEET_CSV_URL === 'YOUR_GOOGLE_SHEET_PUBLISHED_CSV_URL_HERE' || !GOOGLE_SHEET_CSV_URL) {
                    throw new Error("CRITICAL: Google Sheet URL for asset list is not configured.");
                }
                const farmResponse = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!farmResponse.ok) {
                    throw new Error(`HTTP error fetching asset list! Status: ${farmResponse.status}.`);
                }
                const farmCsvText = await farmResponse.text();
                farmData = csvToJSON(farmCsvText);
                if (Object.keys(farmData).length === 0 && farmCsvText.trim() !== '') {
                   throw new Error("No asset data parsed. Check Asset Sheet CSV format/headers (assetId, name, type, description, lat, lon, etc).");
                } else if (Object.keys(farmData).length === 0 && farmCsvText.trim() === '') {
                    throw new Error("Asset Sheet CSV data empty.");
                }
                showUserMessage(messageBox, successMessageText, "Asset list loaded.", true, 3000);

                initializeDashboardMap();
                await loadActivitiesFromSheet();
                await loadTasksFromSheet();
                
                populateRecentActivityLog();
                populateTaskAssetIdDropdown();
                populateTasksDisplay();
                
            } catch (error) {
                console.error("Load initial data error:", error);
                showUserMessage(errorBox, errorMessageText, `Failed to load initial data: ${getErrorMessage(error)}`, false);
            } finally {
                showLoading(false);
            }
        }

        async function loadActivitiesFromSheet() {
             if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_URL) {
                return;
            }
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getActivities`);
                if (!response.ok) {
                    throw new Error(`HTTP error fetching activities! Status: ${response.status}.`);
                }
                const data = await response.json();
                
                if (data.status === "success" && data.activities) {
                    assetActivities = {};
                    data.activities.forEach(activity => {
                        if (!assetActivities[activity.assetId]) {
                            assetActivities[activity.assetId] = [];
                        }
                        if (!assetActivities[activity.assetId].find(a => a.activityId === activity.activityId)) {
                            assetActivities[activity.assetId].push(activity);
                        }
                    });
                    for (const assetIdKey in assetActivities) {
                        assetActivities[assetIdKey].sort((a, b) => new Date(a.userActivityTimestamp || a.timestamp) - new Date(b.userActivityTimestamp || b.timestamp));
                    }
                    showUserMessage(messageBox, successMessageText, "Activities loaded.", true, 3000);
                    populateRecentActivityLog();
                } else {
                    throw new Error(data.message || "Failed to parse activities.");
                }
            } catch (error) {
                console.error("Load activities error:", error);
                showUserMessage(errorBox, errorMessageText, `Failed to load activities: ${getErrorMessage(error)}`, false);
            }
        }

        async function loadTasksFromSheet() {
             if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_URL) {
                if(taskListContainer) taskListContainer.innerHTML = `<p class="text-gray-500">Task loading not configured.</p>`;
                return;
            }
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getTasks`);
                if (!response.ok) {
                    throw new Error(`HTTP error fetching tasks! Status: ${response.status}.`);
                }
                const data = await response.json();
                if (data.status === "success" && data.tasks) {
                    taskListData = data.tasks;
                    showUserMessage(messageBox, successMessageText, "Tasks loaded successfully.", true, 3000);
                    populateTasksDisplay();
                } else {
                    throw new Error(data.message || "Failed to parse tasks.");
                }
            } catch (error) {
                console.error("Load tasks error:", error);
                showUserMessage(errorBox, errorMessageText, `Failed to load tasks: ${getErrorMessage(error)}`, false);
                if(taskListContainer) taskListContainer.innerHTML = `<p class="text-red-500">Error loading tasks.</p>`;
            }
        }

        function initializeDashboardMap() {
            if (dashboardMap) {
                try { dashboardMap.invalidateSize(); } catch(e) { console.warn("Could not invalidate map size on re-init attempt", e); }
                return;
            }
            
            const mapElement = document.getElementById('farmMapViewport');
            if (!mapElement) {
                console.error("Critical: farmMapViewport element not found for Leaflet initialization!");
                showUserMessage(errorBox, errorMessageText, "Map container not found. Dashboard cannot load.", false);
                return;
            }
            
            const defaultLat = 20.74065901504538;
            const defaultLon = -155.9872504358726;

            try {
                dashboardMap = L.map('farmMapViewport', {
                    maxZoom: 24
                }).setView([defaultLat, defaultLon], 19);

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                   attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA FSA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                   maxZoom: 24
                }).addTo(dashboardMap);
                
                populateLeafletMapMarkers();
            } catch (mapError) {
                console.error("Error initializing Leaflet map:", mapError);
                showUserMessage(errorBox, errorMessageText, `Error initializing map: ${getErrorMessage(mapError)}`, false);
            }
        }
        
        function populateLeafletMapMarkers() {
            if (!dashboardMap) {
                console.warn("populateLeafletMapMarkers called but dashboardMap is not initialized.");
                return;
            }
            if (Object.keys(farmData).length === 0) {
                return;
            }
            
            dashboardMap.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                    dashboardMap.removeLayer(layer);
                }
            });

            let markersAddedCount = 0;
            Object.keys(farmData).forEach(assetId => {
                const asset = farmData[assetId];
                const lat = parseFloat(asset.lat);
                const lon = parseFloat(asset.lon);

                if (!isNaN(lat) && !isNaN(lon)) {
                    let markerLabel = (asset.type ? asset.type.substring(0,1) : assetId.substring(0,1)).toUpperCase();
                    let markerClass = 'other-marker'; // Default
                    if (asset.type) {
                        const assetTypeLower = asset.type.toLowerCase();
                        if (assetTypeLower.includes('tree')) { markerClass = 'tree-marker'; }
                        else if (assetTypeLower.includes('plant') || assetTypeLower.includes('vegetable')) { markerClass = 'plant-marker'; }
                        else if (assetTypeLower.includes('poultry')) { markerClass = 'poultry-marker'; }
                        else if (assetTypeLower.includes('structure')) { markerClass = 'structure-marker';}
                    }

                    const divIcon = L.divIcon({
                        className: `leaflet-div-icon ${markerClass}`,
                        html: `<span>${markerLabel}</span>`,
                        iconSize: [28, 28], // Match CSS
                        iconAnchor: [14, 14] // Center of the icon
                    });

                    const marker = L.marker([lat, lon], { icon: divIcon }).addTo(dashboardMap);
                    
                    let popupContent = `<b>${asset.name || assetId}</b><br>${asset.type || 'N/A'}`;
                    let imageUrlToDisplay = asset.imageUrl || '';
                    let notesToDisplay = asset.description || 'No description.';

                    if (assetActivities[assetId] && assetActivities[assetId].length > 0) {
                        const latestActivity = assetActivities[assetId][assetActivities[assetId].length - 1];
                        if (latestActivity.activityImageUrl) {
                            imageUrlToDisplay = latestActivity.activityImageUrl;
                        }
                        if (latestActivity.noteText) {
                            notesToDisplay = latestActivity.noteText;
                        }
                    }

                    if (imageUrlToDisplay) {
                        popupContent += `<br><img src="${imageUrlToDisplay}" alt="Latest image for ${asset.name || assetId}" class="popup-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><p class="text-red-500 text-xs hidden">Image load failed.</p>`;
                    }
                    popupContent += `<div class="popup-notes">${notesToDisplay.length > 100 ? notesToDisplay.substring(0, 100) + '...' : notesToDisplay}</div>`;
                    popupContent += `<button class="text-blue-500 hover:underline text-xs p-1 mt-1 w-full text-center" onclick="openAssetModal('${assetId}')">View Full Details & Log</button>`;

                    marker.bindPopup(popupContent, {maxWidth: 250});
                    markersAddedCount++;
                }
            });
            if (markersAddedCount === 0 && Object.keys(farmData).length > 0) {
                console.warn("No valid lat/lon data found in farmData to create markers.");
            }
        }


        function populateRecentActivityLog(limit = 10) {
            if (!recentActivityContainer) {
                console.error("Recent activity container not found in DOM.");
                return;
            }
            recentActivityContainer.innerHTML = '';

            let allActivitiesFlat = [];
            for (const assetId in assetActivities) {
                assetActivities[assetId].forEach(activity => {
                    allActivitiesFlat.push({
                        ...activity,
                        assetName: farmData[assetId]?.name || assetId,
                    });
                });
            }

            if (allActivitiesFlat.length === 0) {
                recentActivityContainer.innerHTML = '<p class="text-gray-500">No activities logged yet across all assets.</p>';
                return;
            }

            allActivitiesFlat.sort((a, b) =>
                new Date(b.userActivityTimestamp || b.timestamp) - new Date(a.userActivityTimestamp || a.timestamp)
            );

            const activitiesToDisplay = allActivitiesFlat.slice(0, limit);

            activitiesToDisplay.forEach(activity => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'recent-activity-item p-4 border rounded-md bg-gray-50 shadow-sm';
                
                const activityDateToDisplay = activity.userActivityTimestamp || activity.timestamp;
                let imgHTML = '';
                if (activity.activityImageUrl) {
                    imgHTML = `<img src="${activity.activityImageUrl}" alt="Activity for ${activity.assetName}" class="activity-image my-2" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                               <p class="text-red-500 text-sm hidden">Image load failed for ${activity.activityImageUrl}</p>`;
                }

                entryDiv.innerHTML = `
                    <h4 class="font-semibold text-md">${activity.assetName} <span class="text-xs text-gray-400">(${activity.assetId})</span></h4>
                    <p class="text-xs text-gray-500 mb-1">Activity Date: ${formatDisplayDateTime(activityDateToDisplay)}</p>
                    ${imgHTML}
                    <p class="text-sm whitespace-pre-wrap">${activity.noteText || "No note for this activity."}</p>
                    <button class="text-blue-500 hover:underline text-xs mt-2" onclick="openAssetModal('${activity.assetId}')">View Asset & Full Log</button>
                `;
                recentActivityContainer.appendChild(entryDiv);
            });
        }


        function populateTaskAssetIdDropdown() {
            if (!newTaskAssetIdSelect || Object.keys(farmData).length === 0) return;

            while (newTaskAssetIdSelect.options.length > 1) {
                newTaskAssetIdSelect.remove(1);
            }

            Object.keys(farmData).sort((a,b) => (farmData[a].name || a).localeCompare(farmData[b].name || b) ).forEach(assetId => {
                const asset = farmData[assetId];
                const option = document.createElement('option');
                option.value = asset.assetId;
                option.textContent = `${asset.name || 'Unnamed Asset'} (${asset.assetId})`;
                newTaskAssetIdSelect.appendChild(option);
            });
        }

        function openTaskLocationPickerModal() {
            if (!taskLocationModal) return;
            taskLocationModal.classList.add('active');

            if (!taskLocationPickerMap) {
                const defaultCenter = dashboardMap ? dashboardMap.getCenter() : [20.74065901504538, -155.9872504358726];
                const defaultZoom = dashboardMap ? dashboardMap.getZoom() : 17;

                taskLocationPickerMap = L.map('taskLocationPickerMap').setView(defaultCenter, defaultZoom);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri'
                }).addTo(taskLocationPickerMap);
            } else {
                 taskLocationPickerMap.invalidateSize();
            }
            
            if (temporaryTaskMarker) {
                taskLocationPickerMap.removeLayer(temporaryTaskMarker);
                temporaryTaskMarker = null;
            }
            if (newTaskLatInput.value && newTaskLonInput.value) {
                 temporaryTaskMarker = L.marker([parseFloat(newTaskLatInput.value), parseFloat(newTaskLonInput.value)]).addTo(taskLocationPickerMap);
                 taskLocationPickerMap.panTo([parseFloat(newTaskLatInput.value), parseFloat(newTaskLonInput.value)]);
            }

            taskLocationPickerMap.on('click', function(e) {
                if (temporaryTaskMarker) {
                    taskLocationPickerMap.removeLayer(temporaryTaskMarker);
                }
                temporaryTaskMarker = L.marker(e.latlng).addTo(taskLocationPickerMap);
                newTaskLatInput.value = e.latlng.lat.toFixed(6);
                newTaskLonInput.value = e.latlng.lng.toFixed(6);
                if (taskLocationCoordsDisplay) taskLocationCoordsDisplay.textContent = `Lat: ${e.latlng.lat.toFixed(4)}, Lon: ${e.latlng.lng.toFixed(4)}`;
            });
        }

        function closeTaskLocationPickerModal() {
            if (taskLocationPickerMap) {
                taskLocationPickerMap.off('click');
            }
            if (taskLocationModal) taskLocationModal.classList.remove('active');
        }

        function confirmTaskLocation() {
            closeTaskLocationPickerModal();
        }

        function openAssetModal(assetId) {
            selectedAssetIdForModal = assetId;
            const asset = farmData[assetId];
            if (!asset) {
                showUserMessage(errorBox, errorMessageText, `Asset ${assetId} not found.`, false);
                return;
            }

            document.querySelectorAll('.map-asset').forEach(item => item.classList.remove('selected-on-map'));
            const mapItemEl = document.getElementById(`map-item-${assetId}`);
            if (mapItemEl) mapItemEl.classList.add('selected-on-map');

            modalAssetName.textContent = asset.name || assetId;
            
            modalStaticAssetId.textContent = asset.assetId || 'N/A';
            modalStaticAssetName.textContent = asset.name || 'N/A';
            modalStaticAssetType.textContent = asset.type || 'N/A';
            modalStaticAssetDescription.textContent = asset.description || 'No description provided.';

            let displayLastActivityDate = "No activity logged yet.";
            let displayLatestNotes = "No recent activity notes.";
            let displayImageUrl = asset.imageUrl || '';

            if (assetActivities[selectedAssetIdForModal] && assetActivities[selectedAssetIdForModal].length > 0) {
                const latestActivity = assetActivities[selectedAssetIdForModal][assetActivities[selectedAssetIdForModal].length - 1];
                displayLastActivityDate = formatDisplayDateTime(latestActivity.userActivityTimestamp || latestActivity.timestamp);
                displayLatestNotes = latestActivity.noteText || "No note for this latest activity.";
                displayImageUrl = latestActivity.activityImageUrl ? latestActivity.activityImageUrl : (asset.imageUrl || '');
            }

            modalStaticAssetLastActivityDate.textContent = displayLastActivityDate;
            modalStaticAssetLatestNotes.textContent = displayLatestNotes;
            
            modalStaticAssetImageContainer.innerHTML = '';
            if (displayImageUrl) {
                const img = document.createElement('img');
                img.src = displayImageUrl;
                img.alt = `Image for ${asset.name || assetId}`;
                img.className = 'asset-image';
                img.onerror = () => {
                    modalStaticAssetImageContainer.innerHTML = `<p class="text-red-500 text-sm">Image load failed. Check URL: ${displayImageUrl}</p>`;
                };
                modalStaticAssetImageContainer.appendChild(img);
            } else {
                 modalStaticAssetImageContainer.innerHTML = `<p class="text-xs text-gray-400 italic">No image available.</p>`;
            }

            displayModalActivityLog(assetId);
            
            modalNewActivityDateTimeInput.value = formatDateTimeForInput(new Date().toISOString());
            modalNewActivityNoteInput.value = '';
            if (modalNewActivityImageFileInput) modalNewActivityImageFileInput.value = null;
            if (modalNewActivityImagePreview) {
                modalNewActivityImagePreview.src = "#";
                modalNewActivityImagePreview.classList.add('hidden');
            }
            newActivitySelectedFile = null;

            assetInfoModal.classList.add('active');
        }

        function closeAssetModal() {
            assetInfoModal.classList.remove('active');
            selectedAssetIdForModal = null;
            document.querySelectorAll('.map-asset').forEach(item => item.classList.remove('selected-on-map'));
             if (modalNewActivityImagePreview) {
                modalNewActivityImagePreview.src = "#";
                modalNewActivityImagePreview.classList.add('hidden');
            }
            newActivitySelectedFile = null;
        }

        function displayModalActivityLog(assetIdToDisplay) {
            modalLatestActivityDisplay.innerHTML = `<p class="text-center text-gray-500">No activities found for this asset.</p>`;
            if (assetActivities[assetIdToDisplay] && assetActivities[assetIdToDisplay].length > 0) {
                modalLatestActivityDisplay.innerHTML = '';
                [...assetActivities[assetIdToDisplay]].reverse().forEach(activity => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'activity-log-entry';
                    const activityDateToDisplay = activity.userActivityTimestamp || activity.timestamp;
                    let imgHTML = '';
                    if (activity.activityImageUrl) {
                        imgHTML = `<img src="${activity.activityImageUrl}" alt="Activity Image" class="activity-image mb-2" 
                                        onerror="this.alt='Img load fail'; this.style.display='none'; this.nextElementSibling.style.display='block';">
                                   <p class="text-red-500 text-sm hidden">Failed to load: ${activity.activityImageUrl}</p>`;
                    }
                    entryDiv.innerHTML = `
                        <p class="text-xs text-gray-500 mb-1">Activity Date: ${formatDisplayDateTime(activityDateToDisplay)}</p>
                        ${imgHTML}
                        <p class="text-sm whitespace-pre-wrap">${activity.noteText || "No note for this activity."}</p>
                    `;
                    modalLatestActivityDisplay.appendChild(entryDiv);
                });
            }
        }

        async function saveModalActivity() {
            if (!selectedAssetIdForModal) {
                showUserMessage(activityMessageBox, activityMessageText, "Internal error: No asset selected for modal activity.", false);
                return;
            }
            if (!saveModalActivityButton) return;
            saveModalActivityButton.disabled = true;
            saveModalActivityButton.textContent = 'Saving...';
            
            const userActivityTimestamp = modalNewActivityDateTimeInput.value ? new Date(modalNewActivityDateTimeInput.value).toISOString() : new Date().toISOString();
            const noteText = modalNewActivityNoteInput.value.trim();
            
            let imageData = null;
            let imageFileName = null;
            let imageMimeType = null;

            if (newActivitySelectedFile) {
                imageData = newActivitySelectedFile.data;
                imageFileName = newActivitySelectedFile.name;
                imageMimeType = newActivitySelectedFile.type;
            }

            if (!noteText && !imageData && !modalNewActivityDateTimeInput.value) {
                showUserMessage(activityMessageBox, activityMessageText, "Please enter some activity data (date, note, or image).", null);
                saveModalActivityButton.disabled = false;
                saveModalActivityButton.textContent = 'Save Activity to Sheet';
                return;
            }

            const loggingTimestamp = new Date().toISOString();
            const activityId = `ACT-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;

            const activityData = {
                dataType: "activity",
                loggingTimestamp: loggingTimestamp,
                userActivityTimestamp: userActivityTimestamp,
                assetId: selectedAssetIdForModal,
                noteText: noteText,
                activityId: activityId,
                imageData: imageData,
                imageFileName: imageFileName,
                imageMimeType: imageMimeType
            };
            
            showUserMessage(activityMessageBox, activityMessageText, "Saving activity...", null, 10000);

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify(activityData)
                });
                
                if (response.ok) {
                    const responseText = await response.text();
                    try {
                        const jsonResponse = JSON.parse(responseText);
                        if (jsonResponse.status === "success") {
                             showUserMessage(activityMessageBox, activityMessageText, `Activity saved successfully! (ID: ${jsonResponse.activityId || activityId})`, true);
                             if (jsonResponse.activityImageUrl) {
                                 activityData.activityImageUrl = jsonResponse.activityImageUrl;
                             }
                        } else {
                            throw new Error(jsonResponse.message || "Apps Script reported an issue saving activity.");
                        }
                    } catch (e) {
                        console.warn("Activity save: Apps Script response not valid JSON, but HTTP status was OK. Assuming success.", responseText);
                        showUserMessage(activityMessageBox, activityMessageText, "Activity sent to sheet! (Check sheet for confirmation)", true);
                    }
                    
                    delete activityData.imageData;
                    delete activityData.imageFileName;
                    delete activityData.imageMimeType;

                    if (!assetActivities[selectedAssetIdForModal]) {
                        assetActivities[selectedAssetIdForModal] = [];
                    }
                    assetActivities[selectedAssetIdForModal].push(activityData);
                    assetActivities[selectedAssetIdForModal].sort((a, b) => new Date(a.userActivityTimestamp || a.timestamp) - new Date(b.userActivityTimestamp || b.timestamp));

                    openAssetModal(selectedAssetIdForModal);
                    populateRecentActivityLog();

                } else {
                    const errorText = await response.text();
                    console.error("Server response error text (Activity):", errorText);
                    throw new Error(`Failed to save activity. Server responded with ${response.status}.`);
                }
            } catch (error) {
                console.error("Full error object during saveModalActivity:", error);
                showUserMessage(activityMessageBox, activityMessageText, `Error saving activity: ${getErrorMessage(error)}`, false);
            } finally {
                if (saveModalActivityButton) {
                    saveModalActivityButton.disabled = false;
                    saveModalActivityButton.textContent = 'Save Activity to Sheet';
                }
                modalNewActivityDateTimeInput.value = formatDateTimeForInput(new Date().toISOString());
                modalNewActivityNoteInput.value = '';
                if (modalNewActivityImageFileInput) modalNewActivityImageFileInput.value = null;
                if (modalNewActivityImagePreview) {
                    modalNewActivityImagePreview.src = "#";
                    modalNewActivityImagePreview.classList.add('hidden');
                }
                newActivitySelectedFile = null;
            }
        }

        function populateTasksDisplay() {
            if (!taskListContainer) return;
            taskListContainer.innerHTML = '';
            
            const showCompleted = showCompletedTasksToggle ? showCompletedTasksToggle.checked : false;
            
            const filteredTasks = taskListData.filter(task => {
                return showCompleted || task.status !== "Completed";
            });

            if (filteredTasks.length === 0) {
                taskListContainer.innerHTML = `<p class="text-gray-500">${showCompleted ? 'No tasks found.' : 'No open tasks found. Toggle "Show Completed Tasks" to see all.'}</p>`;
                return;
            }

            filteredTasks.sort((a, b) => {
                const priorityOrder = { "High": 0, "Medium": 1, "Low": 2, "": 3 };
                if (priorityOrder[a.priority || ""] !== priorityOrder[b.priority || ""]) {
                    return priorityOrder[a.priority || ""] - priorityOrder[b.priority || ""];
                }
                const dateA = a.dueDate ? new Date(a.dueDate) : (a.status === "Completed" ? new Date(0) : new Date(8640000000000000));
                const dateB = b.dueDate ? new Date(b.dueDate) : (b.status === "Completed" ? new Date(0) : new Date(8640000000000000));
                
                if (a.status === "Completed" && b.status !== "Completed") return 1;
                if (a.status !== "Completed" && b.status === "Completed") return -1;

                if (a.status === "Completed" && b.status === "Completed") {
                    const compDateA = a.completedDate ? new Date(a.completedDate) : new Date(0);
                    const compDateB = b.completedDate ? new Date(b.completedDate) : new Date(0);
                    return compDateB - compDateA;
                }
                return dateA - dateB;
            });


            filteredTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-list-item p-3 border rounded-md bg-gray-50 shadow-sm ${task.status === "Completed" ? 'opacity-70' : ''}`;
                
                let priorityClass = '';
                switch (task.priority) {
                    case 'High': priorityClass = 'priority-High'; break;
                    case 'Medium': priorityClass = 'priority-Medium'; break;
                    case 'Low': priorityClass = 'priority-Low'; break;
                }

                const isCompleted = task.status === "Completed";

                taskDiv.innerHTML = `
                    <div class="flex items-start">
                        <input type="checkbox" id="task-complete-${task.taskId}" class="form-input h-5 w-5 text-green-600 focus:ring-green-500 mr-3 mt-1" 
                               onchange="handleTaskCompletionChange('${task.taskId}', this.checked)" ${isCompleted ? 'checked' : ''}>
                        <div class="flex-1">
                            <h4 class="font-semibold text-md ${priorityClass} ${isCompleted ? 'task-completed' : ''}">${task.displayName || 'Unnamed Task'} 
                                <span class="text-xs text-gray-400 ml-2">(ID: ${task.taskId})</span>
                            </h4>
                            <p class="text-sm text-gray-600 whitespace-pre-wrap ${isCompleted ? 'task-completed' : ''}">${task.description || 'No description.'}</p>
                            <div class="text-xs text-gray-500 mt-2">
                                ${task.dueDate ? `<span>Due: ${formatDisplayDateTime(task.dueDate)}</span>` : ''}
                                ${task.assetId ? `<span class="ml-2">Asset: ${farmData[task.assetId] ? farmData[task.assetId].name : task.assetId}</span>` : ''}
                                ${task.mapZone ? `<span class="ml-2">Zone: ${task.mapZone}</span>` : ''}
                                <br><span>Created: ${formatDisplayDateTime(task.createdDate)}</span>
                                ${isCompleted && task.completedDate ? `<br><span class="text-green-600">Completed: ${formatDisplayDateTime(task.completedDate)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                taskListContainer.appendChild(taskDiv);
            });
        }

        async function handleTaskCompletionChange(taskId, isChecked) {
            const newStatus = isChecked ? "Completed" : "Open";
            
            showUserMessage(taskMessageBox, taskMessageText, `Updating task ${taskId} to ${newStatus}...`, null, 10000);

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: "updateTaskStatus",dataType: "task", taskId: taskId, status: newStatus })
                });

                if (response.ok) {
                    const responseText = await response.text();
                    let success = false;
                    try {
                        const jsonResponse = JSON.parse(responseText);
                        if (jsonResponse.status === "success") {
                            showUserMessage(taskMessageBox, taskMessageText, `Task ${taskId} marked as ${newStatus}.`, true);
                            success = true;
                        } else {
                            throw new Error(jsonResponse.message || "Apps Script reported an issue updating task status.");
                        }
                    } catch (e) {
                         console.warn("Update Task Status: Apps Script response not valid JSON, but HTTP status was OK. Assuming success.", responseText);
                         showUserMessage(taskMessageBox, taskMessageText, `Task ${taskId} status update sent. (Check sheet for confirmation)`, true);
                         success = true;
                    }

                    if(success){
                        const taskIndex = taskListData.findIndex(t => t.taskId === taskId);
                        if (taskIndex > -1) {
                            taskListData[taskIndex].status = newStatus;
                            taskListData[taskIndex].completedDate = newStatus === "Completed" ? new Date().toISOString() : "";
                        }
                        populateTasksDisplay();
                    }

                } else {
                    const errorText = await response.text();
                    console.error("Server response error text (Update Task Status):", errorText);
                    throw new Error(`Failed to update task status. Server responded with ${response.status}.`);
                }
            } catch (error) {
                console.error("Full error object during handleTaskCompletionChange:", error);
                showUserMessage(taskMessageBox, taskMessageText, `Error updating task status: ${getErrorMessage(error)}`, false);
                const checkbox = document.getElementById(`task-complete-${taskId}`);
                if(checkbox) checkbox.checked = !isChecked;
            }
        }


        async function saveNewTask() {
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_URL) {
                showUserMessage(taskMessageBox, taskMessageText, "Task saving is not configured (Apps Script URL missing).", false);
                return;
            }
            if (!saveTaskButton) {
                console.error("CRITICAL: saveTaskButton element is not cached or missing from DOM.");
                showUserMessage(taskMessageBox, taskMessageText, "Task form error (Save button missing). Please refresh.", false);
                return;
            }
            saveTaskButton.disabled = true;
            saveTaskButton.textContent = "Saving...";

            const requiredInputs = {
                newTaskNameInput, newTaskDescriptionInput, newTaskDueDateInput,
                newTaskAssetIdSelect, newTaskMapZoneInput, newTaskPriorityInput,
                newTaskLatInput, newTaskLonInput
            };

            for (const key in requiredInputs) {
                if (!requiredInputs[key]) {
                    console.error(`CRITICAL SAVE ERROR: Task form element variable '${key}' is null. Check ID and cacheDOMElements().`);
                    showUserMessage(taskMessageBox, taskMessageText, `Task form error (element ${key} is missing). Please refresh.`, false);
                    saveTaskButton.disabled = false;
                    saveTaskButton.textContent = "Add Task to Sheet";
                    return;
                }
            }


            const displayName = newTaskNameInput.value.trim();
            const description = newTaskDescriptionInput.value.trim();
            const dueDate = newTaskDueDateInput.value;
            const assetId = newTaskAssetIdSelect.value;
            const mapZone = newTaskMapZoneInput.value.trim();
            const priority = newTaskPriorityInput.value;
            const taskLat = newTaskLatInput.value.trim();
            const taskLon = newTaskLonInput.value.trim();


            if (!displayName) {
                showUserMessage(taskMessageBox, taskMessageText, "Please enter a task name.", null);
                saveTaskButton.disabled = false;
                saveTaskButton.textContent = "Add Task to Sheet";
                return;
            }

            const taskId = `TASK-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            const createdDate = new Date().toISOString();

            const taskData = {
                dataType: "task",
                action: "createTask",
                taskId: taskId,
                displayName: displayName,
                description: description,
                dueDate: dueDate,
                createdDate: createdDate,
                mapZone: mapZone,
                assetId: assetId,
                priority: priority,
                taskLat: taskLat,
                taskLon: taskLon
            };

            showUserMessage(taskMessageBox, taskMessageText, "Saving new task...", null, 10000);

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    const responseText = await response.text();
                     try {
                        const jsonResponse = JSON.parse(responseText);
                        if (jsonResponse.status === "success") {
                             showUserMessage(taskMessageBox, taskMessageText, `Task "${displayName}" saved successfully! (ID: ${jsonResponse.taskId || taskId})`, true);
                        } else {
                            throw new Error(jsonResponse.message || "Apps Script reported an issue saving task.");
                        }
                    } catch (e) {
                        console.warn("Task save: Apps Script response not valid JSON, but HTTP status was OK. Assuming success.", responseText);
                        showUserMessage(taskMessageBox, taskMessageText, "Task sent to sheet! (Check sheet for confirmation)", true);
                    }
                    
                    const newTaskForLocal = {...taskData, status: "Open", completedDate: ""};
                    delete newTaskForLocal.action;
                    delete newTaskForLocal.dataType;

                    taskListData.push(newTaskForLocal);
                    populateTasksDisplay();

                    newTaskNameInput.value = '';
                    newTaskDescriptionInput.value = '';
                    newTaskDueDateInput.value = '';
                    newTaskAssetIdSelect.value = '';
                    newTaskMapZoneInput.value = '';
                    newTaskPriorityInput.value = 'Medium';
                    newTaskLatInput.value = '';
                    newTaskLonInput.value = '';
                    if (taskLocationCoordsDisplay) taskLocationCoordsDisplay.textContent = 'No location set';


                } else {
                    const errorText = await response.text();
                    console.error("Server response error text (Task):", errorText);
                    throw new Error(`Failed to save task. Server responded with ${response.status}.`);
                }
            } catch (error) {
                console.error("Full error object during saveNewTask:", error);
                showUserMessage(taskMessageBox, taskMessageText, `Error saving task: ${getErrorMessage(error)}`, false);
            } finally {
                 if (saveTaskButton) {
                    saveTaskButton.disabled = false;
                    saveTaskButton.textContent = "Add Task to Sheet";
                }
            }
        }

        function openImageZoomModal(imageUrl) {
            if (zoomedImage && imageZoomModal) {
                zoomedImage.src = imageUrl;
                imageZoomModal.classList.add('active');
            }
        }
        function closeImageZoomModal() {
            if (imageZoomModal) {
                imageZoomModal.classList.remove('active');
                if(zoomedImage) zoomedImage.src = "";
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            
            const dashboardTabButton = document.getElementById('dashboardTabButton');
            if (dashboardTabButton) {
                dashboardTabButton.click();
            } else {
                console.error("Dashboard tab button not found on DOMContentLoaded!");
            }
            
            loadInitialData();
            
            if(showCompletedTasksToggle) {
                showCompletedTasksToggle.addEventListener('change', populateTasksDisplay);
            }
            
            if (modalNewActivityImageFileInput) {
                modalNewActivityImageFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            newActivitySelectedFile = {
                                name: file.name,
                                type: file.type,
                                data: e.target.result
                            };
                            if(modalNewActivityImagePreview) {
                                modalNewActivityImagePreview.src = e.target.result;
                                modalNewActivityImagePreview.classList.remove('hidden');
                            }
                        }
                        reader.readAsDataURL(file);
                    } else {
                        newActivitySelectedFile = null;
                         if(modalNewActivityImagePreview) {
                            modalNewActivityImagePreview.src = "#";
                            modalNewActivityImagePreview.classList.add('hidden');
                        }
                    }
                });
            }
        });
    </script>

</body>
</html>
